name: CI/CD ESP32 OTA Release

on:
  workflow_dispatch: # Permet de lancer le workflow manuellement
  release:
    types: [published]
    tags:
      - "V*.*.*" # DÃ©clenche sur les tags comme V1.0.0
      - "v*.*.*" # DÃ©clenche aussi sur les tags comme v1.0.0

jobs:
  build_and_release:
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout du code
        uses: actions/checkout@v4
        with:
          submodules: true

      # --- Ã‰tape 1 : PrÃ©paration de l'environnement ---
      - name: ðŸ› ï¸ PrÃ©paration du Node.js (pour la partie web)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: âš™ï¸ Configuration de PlatformIO Core (pour C++)
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: ðŸ“¦ Installation de PlatformIO
        run: pip install platformio

      # --- Ã‰tape 2 : Compilation du File System (Web) ---
      - name: ðŸ“¦ Installation des dÃ©pendances NPM
        run: npm install

      - name: ðŸŒ Compilation de la partie web (GÃ©nÃ¨re les assets dans /data)
        run: npm run build

      - name: ðŸ’¾ CrÃ©ation de l'image binaire du File System (littlefs.bin / spiffs.bin)
        # PlatformIO prend le contenu de /data et crÃ©e le binaire FS dans .pio/build/esp32dev/
        run: pio run -e esp32dev -t buildfs

      # --- Ã‰tape 3 : Compilation du Firmware C++ ---
      - name: ðŸ”¨ Compilation du Firmware C++
        run: pio run -e esp32dev # Changez 'esp32dev' si besoin

      # --- Ã‰tape 4 : Nommage et prÃ©paration des Assets ---
      - name: ðŸ·ï¸ DÃ©finition des noms des fichiers binaires
        id: assets
        run: |
          # RÃ©cupÃ©rer la version Ã  partir du tag
          VERSION="${GITHUB_REF##*/}"
          FW_BIN="firmware-${VERSION}.bin"
          FS_BIN="web-filesystem-${VERSION}.bin"
          echo "FW_BIN=$FW_BIN" >> $GITHUB_OUTPUT
          echo "FS_BIN=$FS_BIN" >> $GITHUB_OUTPUT

          # Renommage des fichiers compilÃ©s pour la clartÃ©
          cp .pio/build/esp32dev/firmware.bin $FW_BIN
          # Assurez-vous que le nom du FS .bin est correct (souvent littlefs.bin, ou spiffs.bin)
          cp .pio/build/esp32dev/littlefs.bin $FS_BIN

      - name: ðŸ”¢ Calcul des checksums SHA256
        id: checksums
        run: |
          sha256sum ${{ steps.assets.outputs.FW_BIN }} | cut -d ' ' -f 1 > ${{ steps.assets.outputs.FW_BIN }}.sha256
          sha256sum ${{ steps.assets.outputs.FS_BIN }} | cut -d ' ' -f 1 > ${{ steps.assets.outputs.FS_BIN }}.sha256
          echo "FW_SHA256=${{ steps.assets.outputs.FW_BIN }}.sha256" >> $GITHUB_OUTPUT
          echo "FS_SHA256=${{ steps.assets.outputs.FS_BIN }}.sha256" >> $GITHUB_OUTPUT

      # --- Ã‰tape 5 : CrÃ©ation de la Release et Upload des Assets ---
      - name: ðŸ“¤ CrÃ©ation de la GitHub Release et Upload des Assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ steps.assets.outputs.FW_BIN }}
            ${{ steps.assets.outputs.FS_BIN }}
            ${{ steps.checksums.outputs.FW_SHA256 }}
            ${{ steps.checksums.outputs.FS_SHA256 }}
          draft: false
          prerelease: ${{ github.event.release.prerelease }}
          name: Release ${{ github.ref_name }}
          body: |
            ## Nouvelle version : ${{ github.ref_name }}

            Firmware et File System pour mise Ã  jour OTA.
