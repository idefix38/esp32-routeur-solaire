name: CI/CD ESP32 OTA Release

on:
  workflow_dispatch: # Permet de lancer le workflow manuellement
  release:
    types: [created]
    tags:
      - "V*.*.*" # D√©clenche sur les tags comme V1.0.0
      - "v*.*.*" # D√©clenche aussi sur les tags comme v1.0.0

jobs:
  build_and_release:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout du code
        uses: actions/checkout@v4
        with:
          submodules: true

      # --- √âtape 1 : Pr√©paration de l'environnement ---
      - name: üõ†Ô∏è Pr√©paration du Node.js (pour la partie web)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ‚öôÔ∏è Configuration de PlatformIO Core (pour C++)
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: üì¶ Installation de PlatformIO
        run: pip install platformio

      # --- √âtape 2 : Compilation du File System (Web) ---
      - name: üì¶ Installation des d√©pendances NPM
        run: npm install

      - name: üåê Compilation de la partie web (G√©n√®re les assets dans /data)
        run: npm run build

      - name: üíæ Cr√©ation de l'image binaire du File System (littlefs.bin / spiffs.bin)
        # PlatformIO prend le contenu de /data et cr√©e le binaire FS dans .pio/build/esp32dev/
        run: pio run -e esp32dev -t buildfs

      # --- √âtape 3 : Compilation du Firmware C++ ---
      - name: üî® Compilation du Firmware C++
        run: pio run -e esp32dev # Changez 'esp32dev' si besoin

      # --- √âtape 4 : Nommage et pr√©paration des Assets ---
      - name: üè∑Ô∏è D√©finition des noms des fichiers binaires
        id: assets
        run: |
          # R√©cup√©rer la version √† partir du tag
          VERSION="${GITHUB_REF##*/}"
          FW_BIN="firmware-${VERSION}.bin"
          FS_BIN="web-filesystem-${VERSION}.bin"
          echo "FW_BIN=$FW_BIN" >> $GITHUB_OUTPUT
          echo "FS_BIN=$FS_BIN" >> $GITHUB_OUTPUT

          # Renommage des fichiers compil√©s pour la clart√©
          cp .pio/build/esp32dev/firmware.bin $FW_BIN
          # Assurez-vous que le nom du FS .bin est correct (souvent littlefs.bin, ou spiffs.bin)
          cp .pio/build/esp32dev/littlefs.bin $FS_BIN

      # --- √âtape 5 : Cr√©ation de la Release et Upload des Assets ---
      - name: üì§ Cr√©ation de la GitHub Release et Upload des Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ steps.assets.outputs.FW_BIN }}
            ${{ steps.assets.outputs.FS_BIN }}
          draft: false
          prerelease: ${{ github.event.release.prerelease }}
          name: Release ${{ github.ref_name }}
          body: |
            ## Nouvelle version : ${{ github.ref_name }}

            Firmware et File System pour mise √† jour OTA.
